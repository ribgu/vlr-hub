<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VLR - HUB | eDPI</title>
    <link rel="stylesheet" href="..\css\calc.css" />
    <link
      href="https://fonts.googleapis.com/css?family=Montserrat"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap"
      rel="stylesheet"
    />
    <link rel="script" href="../scripts/funcoes.js" />
    <link
      rel="icon"
      type="image/png"
      href="../imgs/valorant-logo-transparent-free-png.webp"
    />
  </head>

  <body id="body">
    <div id="popup" class="popup">
      <div class="popup-content">
        <h2>FAÇA SEU LOGIN</h2>
        <p>Para ter o acesso a essa página faça seu login</p>
        <button id="closeBtn" onclick="abrir_login()">LOGIN</button>
      </div>
    </div>
    <div class="background_calc">
      <div class="header">
        <div class="navbar">
          <a class="links" href="./index.html"> HOME </a>
          <a class="links" href="./agentes.html"> AGENTES </a>
          <a class="links" href="./mapas.html"> MAPAS </a>
          <a class="calc" href="./tips.html"> CALC. eDPI </a>
        </div>
        <button class="sair" id="botao_sair" onclick="limparSessao()">
          SAIR
        </button>
        <button class="login" id="botao_login" onclick="abrir_login()">
          ENTRAR
        </button>
        </div>

      <div class="container">
        <div class="caixa">
          <span class="titulo">eDPI ou Effectve Dots Per Inch</span>
          <p class="texto">
            É o termo é usado para mensurar a sua “verdadeira sensibilidade”
            Assim você pode comparar suas configurações independentemente do
            jogo ou do hardware. Portanto, o eDPI de dois jogadores pode ser
            igual mesmo eles usando DPI’s e Sensibilidades diferentes.
          </p>
        </div>
      </div>
    </div>
    <div class="bloco_calc">
      <div class="container_2">
        <div class="caixa_inputs">
          <div class="caixa_dpi">
            <span class="titulo_calc">DPI:</span>
            <input type="number" id="inp_dpi" />
          </div>
          <div class="caixa_sensi">
            <span class="titulo_calc">SENSIBILIDADE:</span>
            <input type="number" id="inp_sensi" />
          </div>
          <div class="caixa_result">
            <div class="mostrar">
              <span class="titulo_result">SUA eDPI é:</span>
              <div class="caixa_edpi"><span id="resultadoEDPI"></span></div>
            </div>
            <button id="calcular" onclick="calcular_edpi()">CALCULAR</button>
          </div>
          <div id="bloco_alterar">
            <span style="color: white"
              >Você ja possui eDPI, <br />
              deseja alterar?</span
            >
            <button class="alterar" onclick="alterar_edpi()">ALTERAR</button>
          </div>
        </div>

        <div>
          <canvas id="myChart"></canvas>
        </div>

        <div class="caixa_grafico"></div>
      </div>
    </div>
  </body>
</html>
<!-- script do charjs -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  var dados = []
  const labels_linha = [
    'eDPI',
    'MÉDIA eDPI DOS USUÁRIOS'
];


const grafico = document.getElementById('myChart');

const data = {
    labels: labels_linha,
    datasets: [{
        label: 'eDPI',
        data: dados,
        backgroundColor: '#2F3345',
        borderColor: '#2F3345',
        borderWidth: 2
    }
    ]
};

const config = {
    type: 'bar',
    data: data,
    options: {
        maintainAspectRatio: false,

        scales: {
            y: {
                ticks: {
                    beginAtZero: true,
                    color: 'white',
                    font: {
                        size: 18,
                        family: 'Montserrat Ace',
                        weight: 500
                    }
                },
            },
            x: {
                ticks: {
                    color: 'white',
                    font: {
                        size: 18,
                        family: 'Montserrat Ace',
                        weight: 500
                    }
                }
            }
        },
        plugins: {
            title: {
                display: true,
                text: 'COMPARAÇÃO eDPI',
                color: 'white',
                font: {
                    size: 18,

                    family: 'Montserrat Ace',
                    weight: 800
                }
              },  legend: {
                labels: {
                    color:'white',
                    font: {
                        size: 18,
                        family: 'Montserrat Ace',
                        weight: 500
                    }
                }
            }
        }
    }
};

const grafico_eDPI = new Chart(grafico, config);
</script>

<script>

function abrir_login() {
    window.location.href = "login.html";
  }

  function validarSessao() {
  var email = sessionStorage.getItem('EMAIL_USUARIO');
  var nome = sessionStorage.getItem('NOME_USUARIO');

  const botao_login = document.getElementById("botao_login");

  if (email != null && nome != null) {
    botao_login.style.display = "none";
  }
  
  var email = sessionStorage.getItem("EMAIL_USUARIO");
    var nome = sessionStorage.getItem("NOME_USUARIO");

    const body = document.getElementById("body");

    if (email != null && nome != null) {
      popup.style.display = "none";
    }
}


    function limparSessao() {
    sessionStorage.clear();
    window.location.reload(true);
}

  document.addEventListener("DOMContentLoaded", function () {
    const popup = document.getElementById("popup");
    const closeBtn = document.getElementById("closeBtn");

    popup.style.display = "flex";
  });

  window.onload = function () {
    validarSessao();
  };
  function abrir_login() {
    window.location.href = "login.html";
  }

  function calcular_edpi() {
    var dpiVar = Number(inp_dpi.value);
    var sensiVar = Number(inp_sensi.value);
    var eDPIVar = dpiVar * sensiVar;
    const mostrarResult = document.getElementById("resultadoEDPI");

    // fetch para fazer select
    fetch("/usuarios/verificar_eDPI", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        fkUsuarioServer: sessionStorage.ID_USUARIO,
      }),
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO verificareDPI()!");

      // validação para verificar se ja tem edpi

      if (resposta.status == 204) {
        alert("você ja tem eDPI");
        bloco_alterar.style.display = "flex";
        calcular.style.display = "none";
        // aparece o botao que chama a function
      } else {
        // fetch para fazer insert
        fetch("/usuarios/cadastro_eDPI", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            // crie um atributo que recebe o valor recuperado aqui
            // Agora vá para o arquivo routes/usuario.js
            dpiServer: dpiVar,
            sensiServer: sensiVar,
            eDPIServer: eDPIVar,
            fkUsuarioServer: sessionStorage.ID_USUARIO,
          }),
        })
          .then(function (resposta) {
            console.log("resposta: ", resposta);

            if (resposta.ok) {
              console.log("deu certo");
              pegar_dados_grafico();
              mostrarResult.innerHTML = `${eDPIVar}`;
            } else {
              console.log("nao foi");
            }
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
          });

        return false;
      }
    });

    pegar_dados_grafico();
  }

  // função para alterar edpi
  function alterar_edpi() {
    var dpiVar = Number(inp_dpi.value);
    var sensiVar = Number(inp_sensi.value);
    var eDPIVar = dpiVar * sensiVar;
    const mostrarResult = document.getElementById("resultadoEDPI");
    fetch(`/usuarios/alterar_edpi/${sessionStorage.getItem("ID_USUARIO")}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        dpiServer: dpiVar,
        sensiServer: sensiVar,
        eDPIServer: eDPIVar,
        fkUsuarioServer: sessionStorage.ID_USUARIO,
      }),
    })
      .then(function (resposta) {
        if (resposta.ok) {
          window.alert(
            "eDPI atualizado com sucesso pelo usuario de email: " +
              sessionStorage.getItem("EMAIL_USUARIO") +
              "!"
          );
          pegar_dados_grafico();
          mostrarResult.innerHTML = `${eDPIVar}`;
        } else if (resposta.status == 404) {
          window.alert("Deu 404!");
        } else {
          throw (
            "Houve um erro ao tentar realizar a alteração! Código da resposta: " +
            resposta.status
          );
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });

    pegar_dados_grafico();
  }



  function pegar_dados_grafico() {
    //ele ta caindo na model da entrar, algum parametro está errado  e estou deixando esse problema com vc gustavo do futuro
    //eu confio em vc
    // fetch para fazer select do grafico
    fetch("/usuarios/pegar_dados_grafico", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        fkUsuarioServer: sessionStorage.ID_USUARIO,
      }),
    }).then(function (resposta) {
      console.log("ESTOU NO THEN DO verificareDPI!");

      if (resposta.ok) {
        console.log(resposta);
        resposta.json().then((json) => {
          // Adicionando o novo valor ao array data
          dados[0] = json[0].eDPI
          dados[1] = json[0].media_total

          // // Atualizando o gráfico 
          grafico_eDPI.update()


        });
      }
    });
  }

</script>
